<div class="payment-dialog">
  <h2 class="text-xl font-semibold text-gray-900 px-6 pt-6">Record Payment</h2>
  
  <mat-dialog-content class="px-6 py-4">
    <!-- Invoice Summary -->
    <div class="bg-gray-50 rounded-lg p-4 mb-6 border border-gray-200">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-sm font-medium text-gray-500">Invoice #{{ data.invoiceNumber }}</h3>
        <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">
          Due {{ data.dueDate | date:'MMM d, y' }}
        </span>
      </div>
      <div class="flex items-baseline justify-between">
        <span class="text-2xl font-bold text-gray-900">
          {{ data.amount | currency:'ZAR':'symbol':'1.2-2' }}
        </span>
        <span class="text-sm text-gray-500">
          <span class="font-medium">Outstanding:</span> {{ data.amount | currency:'ZAR':'symbol':'1.2-2' }}
        </span>
      </div>
    </div>

    <!-- Payment Form -->
    <form [formGroup]="paymentForm" (ngSubmit)="onSubmit()" class="space-y-5">
      <!-- Amount -->
      <div class="form-group">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Amount to Pay <span class="text-red-500">*</span>
        </label>
        <div class="relative rounded-md shadow-sm">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <span class="text-gray-500 sm:text-sm">R</span>
          </div>
          <input 
            type="number" 
            formControlName="amount"
            step="0.01"
            min="0.01"
            [max]="data.amount * 1.1"
            class="focus:ring-primary-500 focus:border-primary-500 block w-full pl-7 pr-12 sm:text-sm border-gray-300 rounded-md py-2.5"
            placeholder="0.00"
            [ngClass]="{'border-red-300': paymentForm.get('amount')?.invalid && paymentForm.get('amount')?.touched}"
          >
          <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
            <span class="text-gray-500 sm:text-sm">
              {{ paymentForm.get('amount')?.value || 0 | currency:'ZAR':'symbol':'1.2-2' | slice:1 }}
            </span>
          </div>
        </div>
        <div *ngIf="paymentForm.get('amount')?.invalid && paymentForm.get('amount')?.touched" class="mt-1 text-sm text-red-600">
          <div *ngIf="paymentForm.get('amount')?.hasError('required')">Amount is required</div>
          <div *ngIf="paymentForm.get('amount')?.hasError('min')">Amount must be greater than 0</div>
          <div *ngIf="paymentForm.get('amount')?.hasError('maxAmount')">
            Amount cannot exceed {{ data.amount * 1.1 | currency:'ZAR':'symbol':'1.2-2' }}
          </div>
        </div>
      </div>

      <!-- Payment Date -->
      <div class="form-group">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Payment Date <span class="text-red-500">*</span>
        </label>
        <mat-form-field appearance="outline" class="w-full">
          <input 
            matInput 
            [matDatepicker]="picker" 
            formControlName="paymentDate"
            [max]="maxDate"
            [matDatepickerFilter]="notFutureDateFilter"
          >
          <mat-datepicker-toggle matSuffix [for]="picker">
            <mat-icon matDatepickerToggleIcon>calendar_today</mat-icon>
          </mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
        <div *ngIf="paymentForm.get('paymentDate')?.invalid && paymentForm.get('paymentDate')?.touched" class="mt-1 text-sm text-red-600">
          <div *ngIf="paymentForm.get('paymentDate')?.hasError('required')">Payment date is required</div>
          <div *ngIf="paymentForm.get('paymentDate')?.hasError('futureDate')">Payment date cannot be in the future</div>
        </div>
      </div>

      <!-- Payment Method -->
      <div class="form-group">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Payment Method <span class="text-red-500">*</span>
        </label>
        <mat-form-field appearance="outline" class="w-full">
          <mat-select formControlName="paymentMethod" panelClass="payment-method-select">
            <mat-option *ngFor="let method of paymentMethods" [value]="method.value">
              <div class="flex items-center">
                <mat-icon class="mr-2 text-gray-500">{{ method.icon }}</mat-icon>
                <span>{{ method.label }}</span>
              </div>
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Card Details (Conditional) -->
      <div *ngIf="showCardDetails" @fadeInOut class="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
        <div class="flex items-center justify-between">
          <h4 class="text-sm font-medium text-gray-700">Card Details</h4>
          <div class="flex space-x-2">
            <img *ngIf="selectedCardType === 'visa'" src="assets/images/visa.png" alt="Visa" class="h-6">
            <img *ngIf="selectedCardType === 'mastercard'" src="assets/images/mastercard.png" alt="Mastercard" class="h-6">
            <img *ngIf="selectedCardType === 'amex'" src="assets/images/amex.png" alt="American Express" class="h-6">
            <img *ngIf="selectedCardType === 'discover'" src="assets/images/discover.png" alt="Discover" class="h-6">
          </div>
        </div>

        <div class="form-group">
          <label class="block text-sm font-medium text-gray-700 mb-1">Card Number</label>
          <input 
            type="text" 
            formControlName="cardNumber"
            (input)="formatCardNumber($event)"
            placeholder="0000 0000 0000 0000"
            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm py-2.5"
            [ngClass]="{'border-red-300': paymentForm.get('cardNumber')?.invalid && paymentForm.get('cardNumber')?.touched}"
          >
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
            <input 
              type="text" 
              formControlName="cardExpiry"
              (input)="formatExpiryDate($event)"
              placeholder="MM/YY"
              class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm py-2.5"
              [ngClass]="{'border-red-300': paymentForm.get('cardExpiry')?.invalid && paymentForm.get('cardExpiry')?.touched}"
            >
          </div>
          <div class="form-group">
            <label class="block text-sm font-medium text-gray-700 mb-1">CVV</label>
            <div class="relative">
              <input 
                type="password" 
                formControlName="cardCvv"
                placeholder="•••"
                maxlength="4"
                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm py-2.5"
                [ngClass]="{'border-red-300': paymentForm.get('cardCvv')?.invalid && paymentForm.get('cardCvv')?.touched}"
              >
              <mat-icon class="absolute right-3 top-2.5 text-gray-400" matSuffix>lock</mat-icon>
            </div>
          </div>
        </div>
      </div>

      <!-- Reference -->
      <div class="form-group">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Reference (Optional)
        </label>
        <input 
          type="text" 
          formControlName="reference"
          placeholder="e.g. Bank reference, check #, etc."
          class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm py-2.5"
          maxlength="50"
        >
      </div>

      <!-- Notes -->
      <div class="form-group">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Notes (Optional)
        </label>
        <textarea 
          formControlName="notes" 
          rows="2" 
          placeholder="Add any additional notes about this payment"
          class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"
          maxlength="500"
        ></textarea>
      </div>

      <!-- Form Errors -->
      <div *ngIf="paymentForm.hasError('cardDetailsRequired')" class="bg-red-50 border-l-4 border-red-400 p-4 mb-4">
        <div class="flex">
          <div class="flex-shrink-0">
            <mat-icon class="h-5 w-5 text-red-400">error_outline</mat-icon>
          </div>
          <div class="ml-3">
            <p class="text-sm text-red-700">
              Please fill in all card details to complete the payment.
            </p>
          </div>
        </div>
      </div>
    </form>
  </mat-dialog-content>

  <!-- Dialog Actions -->
  <mat-dialog-actions align="end" class="px-6 py-4 bg-gray-50 border-t border-gray-200 rounded-b-lg">
    <button 
      type="button"
      mat-stroked-button 
      color="primary" 
      (click)="onCancel()" 
      [disabled]="isLoading"
      class="px-4 py-2"
    >
      Cancel
    </button>
    <button 
      type="button"
      mat-flat-button 
      color="primary" 
      (click)="onSubmit()" 
      [disabled]="paymentForm.invalid || isLoading"
      class="px-6 py-2.5 ml-3"
      [class.opacity-75]="isLoading"
    >
      <div class="flex items-center">
        <span *ngIf="!isLoading">Record Payment</span>
        <mat-spinner *ngIf="isLoading" diameter="20" class="ml-2"></mat-spinner>
      </div>
    </button>
  </mat-dialog-actions>
</div>

<!-- Animation for showing/hiding card details -->
<ng-template #fadeInOut>
  <ng-content></ng-content>
</ng-template>
